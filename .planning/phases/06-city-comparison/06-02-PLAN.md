---
phase: 06-city-comparison
plan: 02
type: execute
depends_on: ["06-01"]
files_modified: [src/app/compare/page.tsx, src/components/Compare/ComparisonTable.tsx]
---

<objective>
Extend comparison to support 3+ cities and add home base functionality for relative comparisons.

Purpose: Allow comprehensive multi-city comparison with personalized home base reference.
Output: Enhanced /compare page with add/remove cities and home base selection.
</objective>

<context>
@.planning/phases/06-city-comparison/06-01-SUMMARY.md
@src/app/compare/page.tsx
@src/components/Compare/ComparisonTable.tsx

**Current state:** Two-city comparison works
**Enhancements:**
- Support for 3+ cities in comparison
- Home base city selection
- Show differences relative to home base
- URL state for shareable comparisons
</context>

<tasks>

<task type="auto">
  <name>Task 1: Support multiple cities</name>
  <files>src/app/compare/page.tsx</files>
  <action>
Update compare page to support 3+ cities:

1. Change state from two IDs to array:
   ```typescript
   const [selectedCityIds, setSelectedCityIds] = useState<string[]>([]);
   ```

2. Add city function:
   ```typescript
   const addCity = (cityId: string) => {
     if (!selectedCityIds.includes(cityId)) {
       setSelectedCityIds([...selectedCityIds, cityId]);
     }
   };
   ```

3. Remove city function:
   ```typescript
   const removeCity = (cityId: string) => {
     setSelectedCityIds(selectedCityIds.filter(id => id !== cityId));
   };
   ```

4. UI changes:
   - Show selected cities as removable chips/tags
   - Single "Add city" dropdown at the end
   - Maximum of 4-5 cities for usability
   - "Clear all" button

5. Pass array to updated ComparisonTable
  </action>
  <verify>Can add and remove multiple cities</verify>
  <done>Compare page supports 3+ cities</done>
</task>

<task type="auto">
  <name>Task 2: Update ComparisonTable for multi-city</name>
  <files>src/components/Compare/ComparisonTable.tsx</files>
  <action>
Update table to handle variable number of cities:

1. Change props:
   ```typescript
   interface ComparisonTableProps {
     cities: CityWithMetrics[];
     homeBaseId?: string;
   }
   ```

2. Dynamic columns:
   - First column: metric name
   - One column per city
   - If homeBaseId set, show differences vs home base

3. Table header:
   ```tsx
   <tr>
     <th>Metric</th>
     {cities.map(city => (
       <th key={city.id}>
         {city.name}
         {city.id === homeBaseId && <span> (Home)</span>}
       </th>
     ))}
   </tr>
   ```

4. Comparison row updates:
   - Show value for each city
   - If home base set, show % diff from home in smaller text

5. Keep existing section structure
  </action>
  <verify>Table displays correct number of columns for cities</verify>
  <done>ComparisonTable handles multiple cities</done>
</task>

<task type="auto">
  <name>Task 3: Add home base selection</name>
  <files>src/app/compare/page.tsx</files>
  <action>
Add home base city functionality:

1. New state:
   ```typescript
   const [homeBaseId, setHomeBaseId] = useState<string | null>(null);
   ```

2. Home base selector:
   - Only show if 2+ cities selected
   - Dropdown to select one of the selected cities as home base
   - Or: click a "Set as home" button on each city chip

3. When home base is set:
   - Pass to ComparisonTable
   - Show differences as "X% vs [Home City]"
   - Home city column highlighted

4. Clear home base when that city is removed
  </action>
  <verify>Can set home base, differences show relative to it</verify>
  <done>Home base selection functional</done>
</task>

<task type="auto">
  <name>Task 4: URL state for sharing</name>
  <files>src/app/compare/page.tsx</files>
  <action>
Sync comparison state with URL:

1. Use Next.js useSearchParams and useRouter:
   ```typescript
   import { useSearchParams, useRouter } from 'next/navigation';
   ```

2. URL format:
   - /compare?cities=berlin,moscow,lisbon&home=berlin

3. Initialize from URL on mount:
   ```typescript
   useEffect(() => {
     const citiesParam = searchParams.get('cities');
     if (citiesParam) {
       setSelectedCityIds(citiesParam.split(','));
     }
     const homeParam = searchParams.get('home');
     if (homeParam) {
       setHomeBaseId(homeParam);
     }
   }, []);
   ```

4. Update URL when state changes:
   ```typescript
   useEffect(() => {
     const params = new URLSearchParams();
     if (selectedCityIds.length > 0) {
       params.set('cities', selectedCityIds.join(','));
     }
     if (homeBaseId) {
       params.set('home', homeBaseId);
     }
     router.replace(`/compare?${params.toString()}`, { scroll: false });
   }, [selectedCityIds, homeBaseId]);
   ```

5. Handle edge cases:
   - Invalid city IDs in URL
   - Home base not in selected cities
  </action>
  <verify>URL updates with selections, sharing URL restores state</verify>
  <done>URL state synced for shareable comparisons</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Can add 3+ cities to comparison
- [ ] Can remove cities from comparison
- [ ] Table shows all selected cities
- [ ] Home base can be selected
- [ ] Differences show relative to home base
- [ ] URL updates with city selections
- [ ] Loading URL restores selections
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Multi-city comparison fully functional
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-city-comparison/06-02-SUMMARY.md`
</output>
