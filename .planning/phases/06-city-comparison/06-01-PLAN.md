---
phase: 06-city-comparison
plan: 01
type: execute
depends_on: []
files_modified: [src/app/compare/page.tsx, src/components/Compare/CitySelector.tsx, src/components/Compare/ComparisonTable.tsx, src/components/Compare/index.ts]
---

<objective>
Build a two-city comparison view showing metrics side-by-side with difference indicators.

Purpose: Allow users to directly compare cost of living between two cities.
Output: Functional /compare page with city selectors and comparison table.
</objective>

<context>
@.planning/PROJECT.md
@src/lib/data.ts
@src/lib/currency.ts
@src/types/metrics.ts
@src/components/City/MetricCard.tsx

**Data available:** getAllCities(), getCityById()
**Utilities available:** formatMoney, formatCurrency

**Comparison features:**
- Two city selector dropdowns
- Side-by-side metrics in table format
- Show absolute values and percentage difference
- Color coding: green for cheaper, red for more expensive
- All major metric categories
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CitySelector component</name>
  <files>src/components/Compare/CitySelector.tsx, src/components/Compare/index.ts</files>
  <action>
Create city selection dropdown component:

1. Create directory: src/components/Compare/

2. Props interface:
   ```typescript
   interface CitySelectorProps {
     cities: CityIndex[];
     selectedId: string | null;
     onChange: (cityId: string) => void;
     label: string;
     excludeId?: string; // To prevent selecting same city twice
   }
   ```

3. Render as styled select dropdown:
   ```tsx
   <div>
     <label className="block text-sm font-medium text-gray-700">{label}</label>
     <select
       value={selectedId || ''}
       onChange={(e) => onChange(e.target.value)}
       className="mt-1 block w-full rounded-md border-gray-300 shadow-sm ..."
     >
       <option value="">Select a city...</option>
       {cities
         .filter(city => city.id !== excludeId)
         .map(city => (
           <option key={city.id} value={city.id}>
             {city.name}, {city.country}
           </option>
         ))}
     </select>
   </div>
   ```

4. Style with Tailwind:
   - Focus ring on select
   - Proper padding and sizing
   - Disabled state if needed

5. Create barrel export: src/components/Compare/index.ts
  </action>
  <verify>Dropdown renders with all cities, selection works</verify>
  <done>CitySelector component with styled dropdown</done>
</task>

<task type="auto">
  <name>Task 2: Create ComparisonTable component</name>
  <files>src/components/Compare/ComparisonTable.tsx, src/components/Compare/index.ts</files>
  <action>
Create the comparison table showing metrics side-by-side:

1. Props interface:
   ```typescript
   interface ComparisonTableProps {
     cityA: CityWithMetrics;
     cityB: CityWithMetrics;
   }
   ```

2. Helper function for difference calculation:
   ```typescript
   function calculateDiff(a: number, b: number): { diff: number; percent: number } {
     const diff = b - a;
     const percent = a !== 0 ? ((b - a) / a) * 100 : 0;
     return { diff, percent };
   }
   ```

3. Helper for difference styling:
   ```typescript
   function getDiffStyle(percent: number, lowerIsBetter = true): string {
     if (Math.abs(percent) < 1) return 'text-gray-500';
     const isGood = lowerIsBetter ? percent < 0 : percent > 0;
     return isGood ? 'text-green-600' : 'text-red-600';
   }
   ```

4. Table structure:
   ```tsx
   <table className="min-w-full">
     <thead>
       <tr>
         <th>Metric</th>
         <th>{cityA.name}</th>
         <th>{cityB.name}</th>
         <th>Difference</th>
       </tr>
     </thead>
     <tbody>
       {/* Salary row - higher is better */}
       <ComparisonRow
         label="Average Salary"
         valueA={cityA.metrics.salary.average}
         valueB={cityB.metrics.salary.average}
         currencyA={cityA.currency.code}
         currencyB={cityB.currency.code}
         lowerIsBetter={false}
       />
       {/* Rent rows - lower is better */}
       <ComparisonRow label="1BR Rent" ... lowerIsBetter={true} />
       {/* ... more rows */}
     </tbody>
   </table>
   ```

5. ComparisonRow sub-component:
   - Displays metric label
   - City A value (formatted)
   - City B value (formatted)
   - Difference with percentage and arrow/color

6. Categories to compare:
   - Salary: average
   - Rent: 1BR, 2BR, 3BR
   - Property: city center, outside
   - Food: groceries, restaurant, fast food
   - Transport: monthly pass
   - Utilities: basic, internet
   - Lifestyle: gym, cinema, cappuccino

7. Section headers in table for organization

8. Update barrel export
  </action>
  <verify>Table shows all metrics with correct difference calculations</verify>
  <done>ComparisonTable with side-by-side metrics and differences</done>
</task>

<task type="auto">
  <name>Task 3: Build compare page</name>
  <files>src/app/compare/page.tsx</files>
  <action>
Build the full compare page with selectors and table:

1. Make it a client component ('use client') for state management

2. State:
   ```typescript
   const [cityAId, setCityAId] = useState<string | null>(null);
   const [cityBId, setCityBId] = useState<string | null>(null);
   ```

3. Get city data:
   ```typescript
   const cities = getAllCities();
   const cityIndex = getCityIndex();
   const cityA = cityAId ? getCityById(cityAId) : null;
   const cityB = cityBId ? getCityById(cityBId) : null;
   ```

4. Page layout:
   ```tsx
   <div className="space-y-6">
     <div>
       <h1>Compare Cities</h1>
       <p>Select two cities to compare cost of living.</p>
     </div>

     {/* City selectors side by side */}
     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
       <CitySelector
         cities={cityIndex}
         selectedId={cityAId}
         onChange={setCityAId}
         label="First City"
         excludeId={cityBId}
       />
       <CitySelector
         cities={cityIndex}
         selectedId={cityBId}
         onChange={setCityBId}
         label="Second City"
         excludeId={cityAId}
       />
     </div>

     {/* Comparison table - only show when both selected */}
     {cityA && cityB ? (
       <ComparisonTable cityA={cityA} cityB={cityB} />
     ) : (
       <div className="text-center py-12 text-gray-500">
         Select two cities above to compare
       </div>
     )}
   </div>
   ```

5. No metadata export needed (client component)
  </action>
  <verify>Page loads, selectors work, table appears when both cities selected</verify>
  <done>Compare page functional with two-city comparison</done>
</task>

<task type="auto">
  <name>Task 4: Polish and responsive design</name>
  <files>src/components/Compare/ComparisonTable.tsx, src/app/compare/page.tsx</files>
  <action>
Final polish for the comparison feature:

1. Responsive table:
   - Horizontal scroll on mobile
   - Or: stack layout on mobile (city cards instead of table)
   - Minimum: overflow-x-auto wrapper

2. Visual enhancements:
   - Section dividers in table
   - Alternating row colors
   - Sticky first column (metric names) - optional

3. Difference display:
   - Show arrow (↑/↓) with percentage
   - Green/red color coding
   - Gray for minimal difference (<1%)

4. Empty states:
   - Before selection: "Select two cities"
   - After selection: show comparison

5. Quick swap button (optional):
   - Button to swap city A and city B

6. Test with different city pairs:
   - Berlin vs Moscow (different currencies)
   - Berlin vs Lisbon (same currency region)
  </action>
  <verify>Comparison looks good, responsive, all differences calculated correctly</verify>
  <done>Compare page polished and responsive</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] /compare page loads
- [ ] City selectors show all cities
- [ ] Selecting same city in both is prevented
- [ ] Comparison table shows when both selected
- [ ] Differences calculated correctly (% and direction)
- [ ] Green/red color coding works
- [ ] Salary shows higher as better
- [ ] Costs show lower as better
- [ ] Responsive on mobile
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Two-city comparison fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/06-city-comparison/06-01-SUMMARY.md`
</output>
